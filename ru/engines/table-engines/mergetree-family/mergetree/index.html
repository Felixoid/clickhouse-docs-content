<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-ru/engines/table-engines/mergetree-family/mergetree">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KF1LLRTQ5Q"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-KF1LLRTQ5Q",{})</script>
<link rel="search" type="application/opensearchdescription+xml" title="ClickHouse Docs" href="/docs/opensearch.xml">
<script src="https://docs-content.clickhouse.tech/docs/js/analytics.js"></script><title data-rh="true">MergeTree | ClickHouse Docs</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://clickhouse.com/docs/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://clickhouse.com/docs/img/logo.png"><meta data-rh="true" property="og:url" content="https://clickhouse.com/docs/ru/engines/table-engines/mergetree-family/mergetree"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="MergeTree | ClickHouse Docs"><meta data-rh="true" name="description" content="table_engines-mergetree}"><meta data-rh="true" property="og:description" content="table_engines-mergetree}"><link data-rh="true" rel="icon" href="/docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://clickhouse.com/docs/ru/engines/table-engines/mergetree-family/mergetree"><link data-rh="true" rel="alternate" href="https://clickhouse.com/docs/ru/engines/table-engines/mergetree-family/mergetree" hreflang="en"><link data-rh="true" rel="alternate" href="https://clickhouse.com/docs/ru/engines/table-engines/mergetree-family/mergetree" hreflang="x-default"><link rel="stylesheet" href="/docs/assets/css/styles.762d4b44.css">
<link rel="preload" href="/docs/assets/js/runtime~main.832195c1.js" as="script">
<link rel="preload" href="/docs/assets/js/main.0e6c66ce.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://clickhouse.com/" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs/img/clickhouse.svg" alt="ClickHouse" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/docs/img/clickhouse.svg" alt="ClickHouse" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">ClickHouse</b></a><a class="navbar__item navbar__link" href="/docs/en/intro">Docs</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Language</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/en/intro">English</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/ru">Russian</a></li><li><a class="dropdown__link" href="/docs/zh">Chinese</a></li></ul></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD sidebarWithHideableNavbar_d0QC"><a href="https://clickhouse.com/" target="_blank" rel="noopener noreferrer" tabindex="-1" class="sidebarLogo_YUvz"><img src="/docs/img/clickhouse.svg" alt="ClickHouse" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/docs/img/clickhouse.svg" alt="ClickHouse" class="themedImage_W2Cr themedImage--dark_oUvU"><b>ClickHouse</b></a><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/ru/">Что такое ClickHouse</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/введение">Введение</a><button aria-label="Toggle the collapsible sidebar category &#x27;Введение&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/ru/getting-started/">Начало работы</a><button aria-label="Toggle the collapsible sidebar category &#x27;Начало работы&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/ru/interfaces/">Интерфейсы</a><button aria-label="Toggle the collapsible sidebar category &#x27;Интерфейсы&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/engines">Engines</a><button aria-label="Toggle the collapsible sidebar category &#x27;Engines&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/ru/engines/table-engines/">Движки таблиц</a><button aria-label="Toggle the collapsible sidebar category &#x27;Движки таблиц&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/ru/engines/table-engines/mergetree-family/">MergeTree Family</a><button aria-label="Toggle the collapsible sidebar category &#x27;MergeTree Family&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/ru/engines/table-engines/mergetree-family/mergetree">MergeTree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ru/engines/table-engines/mergetree-family/replication">Репликация данных</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ru/engines/table-engines/mergetree-family/custom-partitioning-key">Произвольный ключ партиционирования</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ru/engines/table-engines/mergetree-family/replacingmergetree">ReplacingMergeTree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ru/engines/table-engines/mergetree-family/summingmergetree">SummingMergeTree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ru/engines/table-engines/mergetree-family/aggregatingmergetree">AggregatingMergeTree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ru/engines/table-engines/mergetree-family/collapsingmergetree">CollapsingMergeTree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ru/engines/table-engines/mergetree-family/versionedcollapsingmergetree">VersionedCollapsingMergeTree</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ru/engines/table-engines/mergetree-family/graphitemergetree">GraphiteMergeTree</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/ru/engines/table-engines/log-family/">Семейство Log</a><button aria-label="Toggle the collapsible sidebar category &#x27;Семейство Log&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/ru/engines/table-engines/integrations/">Движки таблиц для интеграции</a><button aria-label="Toggle the collapsible sidebar category &#x27;Движки таблиц для интеграции&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/ru/engines/table-engines/special/">Специальные движки таблиц</a><button aria-label="Toggle the collapsible sidebar category &#x27;Специальные движки таблиц&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/ru/engines/database-engines/">Движки баз данных</a><button aria-label="Toggle the collapsible sidebar category &#x27;Движки баз данных&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/ru/sql-reference/">Справка по SQL</a><button aria-label="Toggle the collapsible sidebar category &#x27;Справка по SQL&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/ru/guides/">Руководства</a><button aria-label="Toggle the collapsible sidebar category &#x27;Руководства&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/ru/operations/">Эксплуатация</a><button aria-label="Toggle the collapsible sidebar category &#x27;Эксплуатация&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/инструкция-для-разработчиков">Инструкция для разработчиков</a><button aria-label="Toggle the collapsible sidebar category &#x27;Инструкция для разработчиков&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/ru/commercial/">Коммерческие услуги</a><button aria-label="Toggle the collapsible sidebar category &#x27;Коммерческие услуги&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/ru/faq/">F.A.Q.</a><button aria-label="Toggle the collapsible sidebar category &#x27;F.A.Q.&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/ru/whats-new/">Что нового?</a><button aria-label="Toggle the collapsible sidebar category &#x27;Что нового?&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/ru/about-us/support">about-us</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/">🏠</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/engines"><span itemprop="name">Engines</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/ru/engines/table-engines/"><span itemprop="name">Движки таблиц</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/ru/engines/table-engines/mergetree-family/"><span itemprop="name">MergeTree Family</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">MergeTree</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>MergeTree</h1><p>Движок <code>MergeTree</code>, а также другие движки этого семейства (<code>*MergeTree</code>) — это наиболее функциональные движки таблиц ClickHouse.</p><p>Основная идея, заложенная в основу движков семейства <code>MergeTree</code> следующая. Когда у вас есть огромное количество данных, которые должны быть вставлены в таблицу, вы должны быстро записать их по частям, а затем объединить части по некоторым правилам в фоновом режиме. Этот метод намного эффективнее, чем постоянная перезапись данных в хранилище при вставке.</p><p>Основные возможности:</p><ul><li><p><strong>Хранит данные, отсортированные по первичному ключу.</strong> Это позволяет создавать разреженный индекс небольшого объёма, который позволяет быстрее находить данные.</p></li><li><p><strong>Позволяет оперировать партициями, если задан <a href="/docs/ru/engines/table-engines/mergetree-family/custom-partitioning-key">ключ партиционирования</a>.</strong> ClickHouse поддерживает отдельные операции с партициями, которые работают эффективнее, чем общие операции с этим же результатом над этими же данными. Также, ClickHouse автоматически отсекает данные по партициям там, где ключ партиционирования указан в запросе. Это также увеличивает эффективность выполнения запросов.</p></li><li><p><strong>Поддерживает репликацию данных.</strong> Для этого используется семейство таблиц <code>ReplicatedMergeTree</code>. Подробнее читайте в разделе <a href="/docs/ru/engines/table-engines/mergetree-family/replication">Репликация данных</a>.</p></li><li><p><strong>Поддерживает сэмплирование данных.</strong> При необходимости можно задать способ сэмплирования данных в таблице.</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Движок <a href="/docs/ru/engines/table-engines/special/merge#merge">Merge</a> не относится к семейству <code>*MergeTree</code>.</p></div></div></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="table_engine-mergetree-creating-a-table">Создание таблицы<a class="hash-link" href="#table_engine-mergetree-creating-a-table" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">IF</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">EXISTS</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">table_name </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">ON</span><span class="token plain"> CLUSTER cluster</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    name1 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">type1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">DEFAULT</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">MATERIALIZED</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">ALIAS expr1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">TTL expr1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    name2 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">type2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">DEFAULT</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">MATERIALIZED</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">ALIAS expr2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">TTL expr2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">INDEX</span><span class="token plain"> index_name1 expr1 </span><span class="token keyword" style="color:rgb(0, 0, 255)">TYPE</span><span class="token plain"> type1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> GRANULARITY value1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">INDEX</span><span class="token plain"> index_name2 expr2 </span><span class="token keyword" style="color:rgb(0, 0, 255)">TYPE</span><span class="token plain"> type2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> GRANULARITY value2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> MergeTree</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> expr</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> expr</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">KEY</span><span class="token plain"> expr</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">SAMPLE </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> expr</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">TTL expr</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">DELETE</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token keyword" style="color:rgb(0, 0, 255)">TO</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">DISK</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;xxx&#x27;</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token keyword" style="color:rgb(0, 0, 255)">TO</span><span class="token plain"> VOLUME </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;xxx&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> conditions</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> key_expr </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">SET</span><span class="token plain"> v1 </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> aggr_func</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">v1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> v2 </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> aggr_func</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">v2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">SETTINGS name</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token keyword" style="color:rgb(0, 0, 255)">value</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Описание параметров смотрите в <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree">описании запроса CREATE</a>.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="mergetree-query-clauses">Секции запроса<a class="hash-link" href="#mergetree-query-clauses" title="Direct link to heading">​</a></h3><ul><li><p><code>ENGINE</code> — имя и параметры движка. <code>ENGINE = MergeTree()</code>. <code>MergeTree</code> не имеет параметров.</p></li><li><p><code>ORDER BY</code> — ключ сортировки.</p><p>Кортеж столбцов или произвольных выражений. Пример: <code>ORDER BY (CounterID, EventDate)</code>.</p><p>ClickHouse использует ключ сортировки в качестве первичного ключа, если первичный ключ не задан в секции <code>PRIMARY KEY</code>.</p><p>Чтобы отключить сортировку, используйте синтаксис <code>ORDER BY tuple()</code>. Смотрите <a href="#primary-keys-and-indexes-in-queries">выбор первичного ключа</a>.</p></li><li><p><code>PARTITION BY</code> — <a href="/docs/ru/engines/table-engines/mergetree-family/custom-partitioning-key">ключ партиционирования</a>. Необязательный параметр.</p><p>Для партиционирования по месяцам используйте выражение <code>toYYYYMM(date_column)</code>, где <code>date_column</code> — столбец с датой типа <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree">Date</a>. В этом случае имена партиций имеют формат <code>&quot;YYYYMM&quot;</code>.</p></li><li><p><code>PRIMARY KEY</code> — первичный ключ, если он <a href="#choosing-a-primary-key-that-differs-from-the-sorting-key">отличается от ключа сортировки</a>. Необязательный параметр.</p><p>По умолчанию первичный ключ совпадает с ключом сортировки (который задаётся секцией <code>ORDER BY</code>.) Поэтому в большинстве случаев секцию <code>PRIMARY KEY</code> отдельно указывать не нужно.</p></li><li><p><code>SAMPLE BY</code> — выражение для сэмплирования. Необязательный параметр.</p><p>Если используется выражение для сэмплирования, то первичный ключ должен содержать его. Результат выражения для сэмплирования должен быть беззнаковым целым числом. Пример: <code>SAMPLE BY intHash32(UserID) ORDER BY (CounterID, EventDate, intHash32(UserID))</code>.</p></li><li><p><code>TTL</code> — список правил, определяющих длительности хранения строк, а также задающих правила перемещения частей на определённые тома или диски. Необязательный параметр.</p><p>Выражение должно возвращать столбец <code>Date</code> или <code>DateTime</code>. Пример: <code>TTL date + INTERVAL 1 DAY</code>.</p><p>Тип правила <code>DELETE|TO DISK &#x27;xxx&#x27;|TO VOLUME &#x27;xxx&#x27;|GROUP BY</code> указывает действие, которое будет выполнено с частью: удаление строк (прореживание), перемещение (при выполнении условия для всех строк части) на определённый диск (<code>TO DISK &#x27;xxx&#x27;</code>) или том (<code>TO VOLUME &#x27;xxx&#x27;</code>), или агрегирование данных в устаревших строках. Поведение по умолчанию соответствует удалению строк (<code>DELETE</code>). В списке правил может быть указано только одно выражение с поведением <code>DELETE</code>.</p><p>Дополнительные сведения смотрите в разделе <a href="#table_engine-mergetree-ttl">TTL для столбцов и таблиц</a></p></li><li><p><code>SETTINGS</code> — дополнительные параметры, регулирующие поведение <code>MergeTree</code> (необязательные):</p><ul><li><code>index_granularity</code> — максимальное количество строк данных между засечками индекса. По умолчанию — 8192. Смотрите <a href="#mergetree-data-storage">Хранение данных</a>.</li><li><code>index_granularity_bytes</code> — максимальный размер гранул данных в байтах. По умолчанию — 10Mb. Чтобы ограничить размер гранул только количеством строк, установите значение 0 (не рекомендовано). Смотрите <a href="#mergetree-data-storage">Хранение данных</a>.</li><li><code>min_index_granularity_bytes</code> — минимально допустимый размер гранул данных в байтах. Значение по умолчанию — 1024b. Для обеспечения защиты от случайного создания таблиц с очень низким значением <code>index_granularity_bytes</code>. Смотрите <a href="#mergetree-data-storage">Хранение данных</a>.</li><li><code>enable_mixed_granularity_parts</code> — включает или выключает переход к ограничению размера гранул с помощью настройки <code>index_granularity_bytes</code>. Настройка <code>index_granularity_bytes</code> улучшает производительность ClickHouse при выборке данных из таблиц с большими (десятки и сотни мегабайтов) строками. Если у вас есть таблицы с большими строками, можно включить эту настройку, чтобы повысить эффективность запросов <code>SELECT</code>.</li><li><code>use_minimalistic_part_header_in_zookeeper</code> — Способ хранения заголовков кусков данных в ZooKeeper. Если  <code>use_minimalistic_part_header_in_zookeeper = 1</code>, то ZooKeeper хранит меньше данных. Подробнее читайте в <a href="/docs/ru/operations/server-configuration-parameters/settings#server-settings-use_minimalistic_part_header_in_zookeeper">описании настройки</a> в разделе &quot;Конфигурационные параметры сервера&quot;.</li><li><code>min_merge_bytes_to_use_direct_io</code> — минимальный объём данных при слиянии, необходимый для прямого (небуферизованного) чтения/записи (direct I/O) на диск. При слиянии частей данных ClickHouse вычисляет общий объём хранения всех данных, подлежащих слиянию. Если общий объём хранения всех данных для чтения превышает <code>min_bytes_to_use_direct_io</code> байт, тогда ClickHouse  использует флаг <code>O_DIRECT</code> при чтении данных с диска. Если <code>min_merge_bytes_to_use_direct_io = 0</code>, тогда прямой ввод-вывод отключен. Значение по умолчанию: <code>10 * 1024 * 1024 * 1024</code> байтов.</li><li><code>merge_with_ttl_timeout</code> — минимальное время в секундах перед повторным слиянием для удаления данных с истекшим TTL. По умолчанию: <code>14400</code> секунд (4 часа).</li><li><code>merge_with_recompression_ttl_timeout</code> — минимальное время в секундах перед повторным слиянием для повторного сжатия данных с истекшим TTL. По умолчанию: <code>14400</code> секунд (4 часа).</li><li><code>try_fetch_recompressed_part_timeout</code> — время ожидания (в секундах) перед началом слияния с повторным сжатием. В течение этого времени ClickHouse пытается извлечь сжатую часть из реплики, которая назначила это слияние. Значение по умолчанию: <code>7200</code> секунд (2 часа).   </li><li><code>write_final_mark</code> — включает или отключает запись последней засечки индекса в конце куска данных, указывающей за последний байт. По умолчанию — 1. Не отключайте её.</li><li><code>merge_max_block_size</code> — максимальное количество строк в блоке для операций слияния. Значение по умолчанию: 8192.</li><li><code>storage_policy</code> — политика хранения данных. Смотрите <a href="#table_engine-mergetree-multiple-volumes">Хранение данных таблицы на нескольких блочных устройствах</a>.</li><li><code>min_bytes_for_wide_part</code>, <code>min_rows_for_wide_part</code> — минимальное количество байт/строк в куске данных для хранения в формате <code>Wide</code>. Можно задать одну или обе настройки или не задавать ни одной. Подробнее см. в разделе <a href="#mergetree-data-storage">Хранение данных</a>.</li><li><code>max_parts_in_total</code> — максимальное количество кусков во всех партициях.</li><li><code>max_compress_block_size</code> — максимальный размер блоков несжатых данных перед сжатием для записи в таблицу. Вы также можете задать этот параметр в глобальных настройках (смотрите <a href="/docs/ru/operations/settings/settings#max-compress-block-size">max_compress_block_size</a>). Настройка, которая задается при создании таблицы, имеет более высокий приоритет, чем глобальная.</li><li><code>min_compress_block_size</code> — минимальный размер блоков несжатых данных, необходимых для сжатия при записи следующей засечки. Вы также можете задать этот параметр в глобальных настройках (смотрите <a href="/docs/ru/operations/settings/settings#min-compress-block-size">min_compress_block_size</a>). Настройка, которая задается при создании таблицы, имеет более высокий приоритет, чем глобальная.</li><li><code>max_partitions_to_read</code> — Ограничивает максимальное число партиций для чтения в одном запросе. Также возможно указать настройку <a href="/docs/ru/operations/settings/merge-tree-settings#max-partitions-to-read">max_partitions_to_read</a> в глобальных настройках.</li></ul></li></ul><p><strong>Пример задания секций</strong></p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> MergeTree</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> toYYYYMM</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">EventDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">CounterID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> EventDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> intHash32</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> SAMPLE </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> intHash32</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> SETTINGS index_granularity</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">8192</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>В примере мы устанавливаем партиционирование по месяцам.</p><p>Также мы задаем выражение для сэмплирования в виде хэша по идентификатору посетителя. Это позволяет псевдослучайным образом перемешать данные в таблице для каждого <code>CounterID</code> и <code>EventDate</code>. Если при выборке данных задать секцию <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree#select-sample-clause">SAMPLE</a>, то ClickHouse вернёт равномерно-псевдослучайную выборку данных для подмножества посетителей.</p><p><code>index_granularity</code> можно было не указывать, поскольку 8192 — это значение по умолчанию.</p><details markdown="1" class="details_lb9f alert alert--info details_BAp3" data-collapsed="true"><summary>Устаревший способ создания таблицы</summary><div><div class="collapsibleContent_i85q"><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token plain">:::note &quot;Attention&quot;</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Не используйте этот способ в новых проектах и по возможности переведите старые проекты на способ, описанный выше.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">:::</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">IF</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">EXISTS</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">db</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain">table_name </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">ON</span><span class="token plain"> CLUSTER cluster</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    name1 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">type1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">DEFAULT</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">MATERIALIZED</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">ALIAS expr1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    name2 </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token plain">type2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">DEFAULT</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">MATERIALIZED</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">ALIAS expr2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> MergeTree</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token keyword" style="color:rgb(0, 0, 255)">date</span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token keyword" style="color:rgb(0, 0, 255)">column</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> sampling_expression</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token keyword" style="color:rgb(0, 0, 255)">primary</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">key</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> index_granularity</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p><strong>Параметры MergeTree()</strong></p><ul><li><code>date-column</code> — имя столбца с типом <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree">Date</a>. На основе этого столбца ClickHouse автоматически создаёт партиции по месяцам. Имена партиций имеют формат <code>&quot;YYYYMM&quot;</code>.</li><li><code>sampling_expression</code> — выражение для сэмплирования.</li><li><code>(primary, key)</code> — первичный ключ. Тип — <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree">Tuple()</a></li><li><code>index_granularity</code> — гранулярность индекса. Число строк данных между «засечками» индекса. Для большинства задач подходит значение 8192.</li></ul><p><strong>Пример</strong></p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token plain">MergeTree</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">EventDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> intHash32</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">CounterID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> EventDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> intHash32</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8192</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Движок <code>MergeTree</code> сконфигурирован таким же образом, как и в примере выше для основного способа конфигурирования движка.</p></div></div></details><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="mergetree-data-storage">Хранение данных<a class="hash-link" href="#mergetree-data-storage" title="Direct link to heading">​</a></h2><p>Таблица состоит из <em>кусков</em> данных (data parts), отсортированных по первичному ключу.</p><p>При вставке в таблицу создаются отдельные куски данных, каждый из которых лексикографически отсортирован по первичному ключу. Например, если первичный ключ — <code>(CounterID, Date)</code>, то данные в куске будут лежать в порядке <code>CounterID</code>, а для каждого <code>CounterID</code> в порядке <code>Date</code>.</p><p>Данные, относящиеся к разным партициям, разбиваются на разные куски. В фоновом режиме ClickHouse выполняет слияния (merge) кусков данных для более эффективного хранения. Куски, относящиеся к разным партициям не объединяются. Механизм слияния не гарантирует, что все строки с одинаковым первичным ключом окажутся в одном куске.</p><p>Куски данных могут храниться в формате <code>Wide</code> или <code>Compact</code>. В формате <code>Wide</code> каждый столбец хранится в отдельном файле, а в формате <code>Compact</code> все столбцы хранятся в одном файле. Формат <code>Compact</code> может быть полезен для повышения производительности при частом добавлении небольших объемов данных.</p><p>Формат хранения определяется настройками движка <code>min_bytes_for_wide_part</code> и <code>min_rows_for_wide_part</code>. Если число байт или строк в куске данных меньше значения, указанного в соответствующей настройке, тогда этот кусок данных хранится в формате <code>Compact</code>. В противном случае кусок данных хранится в формате <code>Wide</code>. Если ни одна из настроек не задана, куски данных хранятся в формате <code>Wide</code>.</p><p>Каждый кусок данных логически делится на гранулы. Гранула — это минимальный неделимый набор данных, который ClickHouse считывает при выборке данных. ClickHouse не разбивает строки и значения и гранула всегда содержит целое число строк. Первая строка гранулы помечается значением первичного ключа для этой строки (засечка). Для каждого куска данных ClickHouse создаёт файл с засечками (индексный файл). Для каждого столбца, независимо от того, входит он в первичный ключ или нет, ClickHouse также сохраняет эти же засечки. Засечки используются для поиска данных напрямую в файлах столбцов.</p><p>Размер гранул оганичен настройками движка <code>index_granularity</code> и <code>index_granularity_bytes</code>. Количество строк в грануле лежит в диапазоне <code>[1, index_granularity]</code>, в зависимости от размера строк. Размер гранулы может превышать <code>index_granularity_bytes</code> в том случае, когда размер единственной строки в грануле превышает значение настройки. В этом случае, размер гранулы равен размеру строки.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="primary-keys-and-indexes-in-queries">Первичные ключи и индексы в запросах<a class="hash-link" href="#primary-keys-and-indexes-in-queries" title="Direct link to heading">​</a></h2><p>Рассмотрим первичный ключ — <code>(CounterID, Date)</code>. В этом случае сортировку и индекс можно проиллюстрировать следующим образом:</p><div class="codeBlockContainer_I0IT language-text theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token plain">Whole data:     [-------------------------------------------------------------------------]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">CounterID:      [aaaaaaaaaaaaaaaaaabbbbcdeeeeeeeeeeeeefgggggggghhhhhhhhhiiiiiiiiikllllllll]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Date:           [1111111222222233331233211111222222333211111112122222223111112223311122333]</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Marks:           |      |      |      |      |      |      |      |      |      |      |</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                a,1    a,2    a,3    b,3    e,2    e,3    g,1    h,2    i,1    i,3    l,3</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">Marks numbers:   0      1      2      3      4      5      6      7      8      9      10</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Если в запросе к данным указать:</p><ul><li><code>CounterID IN (&#x27;a&#x27;, &#x27;h&#x27;)</code>, то сервер читает данные в диапазонах засечек <code>[0, 3)</code> и <code>[6, 8)</code>.</li><li><code>CounterID IN (&#x27;a&#x27;, &#x27;h&#x27;) AND Date = 3</code>, то сервер читает данные в диапазонах засечек <code>[1, 3)</code> и <code>[7, 8)</code>.</li><li><code>Date = 3</code>, то сервер читает данные в диапазоне засечек <code>[1, 10]</code>.</li></ul><p>Примеры выше показывают, что использование индекса всегда эффективнее, чем full scan.</p><p>Разреженный индекс допускает чтение лишних строк. При чтении одного диапазона первичного ключа, может быть прочитано до <code>index_granularity * 2</code> лишних строк в каждом блоке данных.</p><p>Разреженный индекс почти всегда помещается в оперативную память и позволяет работать с очень большим количеством строк в таблицах.</p><p>ClickHouse не требует уникального первичного ключа. Можно вставить много строк с одинаковым первичным ключом.</p><p>Ключ в <code>PRIMARY KEY</code> и <code>ORDER BY</code> может иметь тип <code>Nullable</code>. За поддержку этой возможности отвечает настройка <a href="/docs/ru/operations/settings/settings#allow-nullable-key">allow_nullable_key</a>.</p><p>При сортировке с использованием выражения <code>ORDER BY</code> для значений <code>NULL</code> всегда работает принцип <a href="/docs/ru/sql-reference/statements/select/order-by#sorting-of-special-values">NULLS_LAST</a>.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="selecting-the-primary-key">Выбор первичного ключа<a class="hash-link" href="#selecting-the-primary-key" title="Direct link to heading">​</a></h3><p>Количество столбцов в первичном ключе не ограничено явным образом. В зависимости от структуры данных в первичный ключ можно включать больше или меньше столбцов. Это может:</p><ul><li><p>Увеличить эффективность индекса.</p><p>Пусть первичный ключ — <code>(a, b)</code>, тогда добавление ещё одного столбца <code>c</code> повысит эффективность, если выполнены условия:</p><ul><li>Есть запросы с условием на столбец <code>c</code>.</li><li>Часто встречаются достаточно длинные (в несколько раз больше <code>index_granularity</code>) диапазоны данных с одинаковыми значениями <code>(a, b)</code>. Иначе говоря, когда добавление ещё одного столбца позволит пропускать достаточно длинные диапазоны данных.</li></ul></li><li><p>Улучшить сжатие данных.</p><p>ClickHouse сортирует данные по первичному ключу, поэтому чем выше однородность, тем лучше сжатие.</p></li><li><p>Обеспечить дополнительную логику при слиянии кусков данных в движках <a href="/docs/ru/engines/table-engines/mergetree-family/collapsingmergetree#table_engine-collapsingmergetree">CollapsingMergeTree</a> и <a href="/docs/ru/engines/table-engines/mergetree-family/summingmergetree">SummingMergeTree</a>.</p><p>В этом случае имеет смысл указать отдельный <em>ключ сортировки</em>, отличающийся от первичного ключа.</p></li></ul><p>Длинный первичный ключ будет негативно влиять на производительность вставки и потребление памяти, однако на производительность ClickHouse при запросах <code>SELECT</code> лишние столбцы в первичном ключе не влияют.</p><p>Вы можете создать таблицу без первичного ключа, используя синтаксис <code>ORDER BY tuple()</code>. В этом случае ClickHouse хранит данные в порядке вставки. Если вы хотите сохранить порядок данных при вставке данных с помощью запросов <code>INSERT ... SELECT</code>, установите <a href="/docs/ru/operations/settings/settings#settings-max-insert-threads">max_insert_threads = 1</a>.</p><p>Чтобы выбрать данные в первоначальном порядке, используйте
<a href="/docs/ru/operations/settings/settings#settings-max_threads">однопоточные</a> запросы `SELECT.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="choosing-a-primary-key-that-differs-from-the-sorting-key">Первичный ключ, отличный от ключа сортировки<a class="hash-link" href="#choosing-a-primary-key-that-differs-from-the-sorting-key" title="Direct link to heading">​</a></h3><p>Существует возможность задать первичный ключ (выражение, значения которого будут записаны в индексный файл для
каждой засечки), отличный от ключа сортировки (выражение, по которому будут упорядочены строки в кусках
данных). Кортеж выражения первичного ключа при этом должен быть префиксом кортежа выражения ключа
сортировки.</p><p>Данная возможность особенно полезна при использовании движков <a href="/docs/ru/engines/table-engines/mergetree-family/summingmergetree">SummingMergeTree</a>
и <a href="/docs/ru/engines/table-engines/mergetree-family/aggregatingmergetree">AggregatingMergeTree</a>. В типичном сценарии использования этих движков таблица
содержит столбцы двух типов: <em>измерения</em> (dimensions) и <em>меры</em> (measures). Типичные запросы агрегируют
значения столбцов-мер с произвольной группировкой и фильтрацией по измерениям. Так как <code>SummingMergeTree</code>
и <code>AggregatingMergeTree</code> производят фоновую агрегацию строк с одинаковым значением ключа сортировки, приходится
добавлять в него все столбцы-измерения. В результате выражение ключа содержит большой список столбцов,
который приходится постоянно расширять при добавлении новых измерений.</p><p>В этом сценарии имеет смысл оставить в первичном ключе всего несколько столбцов, которые обеспечат эффективную фильтрацию по индексу, а остальные столбцы-измерения добавить в выражение ключа сортировки.</p><p><a href="/docs/ru/engines/table-engines/mergetree-family/mergetree">ALTER ключа сортировки</a> — лёгкая операция, так как при одновременном добавлении нового столбца в таблицу и ключ сортировки не нужно изменять данные кусков (они остаются упорядоченными и по новому выражению ключа).</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="use-of-indexes-and-partitions-in-queries">Использование индексов и партиций в запросах<a class="hash-link" href="#use-of-indexes-and-partitions-in-queries" title="Direct link to heading">​</a></h3><p>Для запросов <code>SELECT</code> ClickHouse анализирует возможность использования индекса. Индекс может использоваться, если в секции <code>WHERE/PREWHERE</code>, в качестве одного из элементов конъюнкции, или целиком, есть выражение, представляющее операции сравнения на равенства, неравенства, а также <code>IN</code> или <code>LIKE</code> с фиксированным префиксом, над столбцами или выражениями, входящими в первичный ключ или ключ партиционирования, либо над некоторыми частично монотонными функциями от этих столбцов, а также логические связки над такими выражениями.</p><p>Таким образом, обеспечивается возможность быстро выполнять запросы по одному или многим диапазонам первичного ключа. Например, в указанном примере будут быстро работать запросы для конкретного счётчика; для конкретного счётчика и диапазона дат; для конкретного счётчика и даты, для нескольких счётчиков и диапазона дат и т. п.</p><p>Рассмотрим движок сконфигурированный следующим образом:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> MergeTree</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> toYYYYMM</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">EventDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">CounterID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> EventDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> SETTINGS index_granularity</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token number" style="color:rgb(9, 134, 88)">8192</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>В этом случае в запросах:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">count</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">table</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> EventDate </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> toDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token function" style="color:rgb(0, 0, 255)">now</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">AND</span><span class="token plain"> CounterID </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">34</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">count</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">table</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> EventDate </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> toDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token function" style="color:rgb(0, 0, 255)">now</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">CounterID </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">34</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">OR</span><span class="token plain"> CounterID </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">42</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">count</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">table</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">EventDate </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;=</span><span class="token plain"> toDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;2014-01-01&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">AND</span><span class="token plain"> EventDate </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;=</span><span class="token plain"> toDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;2014-01-31&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">OR</span><span class="token plain"> EventDate </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> toDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;2014-05-01&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">AND</span><span class="token plain"> CounterID </span><span class="token operator" style="color:rgb(0, 0, 0)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">101500</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">731962</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">160656</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">CounterID </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">101500</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">OR</span><span class="token plain"> EventDate </span><span class="token operator" style="color:rgb(0, 0, 0)">!=</span><span class="token plain"> toDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;2014-05-01&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>ClickHouse будет использовать индекс по первичному ключу для отсечения не подходящих данных, а также ключ партиционирования по месяцам для отсечения партиций, которые находятся в не подходящих диапазонах дат.</p><p>Запросы выше показывают, что индекс используется даже для сложных выражений. Чтение из таблицы организовано так, что использование индекса не может быть медленнее, чем full scan.</p><p>В примере ниже индекс не может использоваться.</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">count</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">table</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> CounterID </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">34</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">OR</span><span class="token plain"> URL </span><span class="token operator" style="color:rgb(0, 0, 0)">LIKE</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;%upyachka%&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Чтобы проверить, сможет ли ClickHouse использовать индекс при выполнении запроса, используйте настройки <a href="/docs/ru/operations/settings/settings#settings-force_index_by_date">force_index_by_date</a> и <a href="/docs/ru/operations/settings/settings#settings-force_primary_key">force_primary_key</a>.</p><p>Ключ партиционирования по месяцам обеспечивает чтение только тех блоков данных, которые содержат даты из нужного диапазона. При этом блок данных может содержать данные за многие даты (до целого месяца). В пределах одного блока данные упорядочены по первичному ключу, который может не содержать дату в качестве первого столбца. В связи с этим, при использовании запроса с указанием условия только на дату, но не на префикс первичного ключа, будет читаться данных больше, чем за одну дату.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="use-of-index-for-partially-monotonic-primary-keys">Использование индекса для частично-монотонных первичных ключей<a class="hash-link" href="#use-of-index-for-partially-monotonic-primary-keys" title="Direct link to heading">​</a></h3><p>Рассмотрим, например, дни месяца. Они образуют последовательность <a href="https://ru.wikipedia.org/wiki/%D0%9C%D0%BE%D0%BD%D0%BE%D1%82%D0%BE%D0%BD%D0%BD%D0%B0%D1%8F_%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D1%8C" target="_blank" rel="noopener noreferrer">монотонную</a> в течение одного месяца, но не монотонную на более длительных периодах. Это частично-монотонная последовательность. Если пользователь создаёт таблицу с частично-монотонным первичным ключом, ClickHouse как обычно создаёт разреженный индекс. Когда пользователь выбирает данные из такого рода таблиц, ClickHouse анализирует условия запроса. Если пользователь хочет получить данные между двумя метками индекса, и обе эти метки находятся внутри одного месяца, ClickHouse может использовать индекс в данном конкретном случае, поскольку он может рассчитать расстояние между параметрами запроса и индексными метками.</p><p>ClickHouse не может использовать индекс, если значения первичного ключа в диапазоне параметров запроса не представляют собой монотонную последовательность. В этом случае ClickHouse использует метод полного сканирования.</p><p>ClickHouse использует эту логику не только для последовательностей дней месяца, но и для любого частично-монотонного первичного ключа.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="table_engine-mergetree-data_skipping-indexes">Индексы пропуска данных<a class="hash-link" href="#table_engine-mergetree-data_skipping-indexes" title="Direct link to heading">​</a></h3><p>Объявление индексов при определении столбцов в запросе <code>CREATE</code>.</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">INDEX</span><span class="token plain"> index_name expr </span><span class="token keyword" style="color:rgb(0, 0, 255)">TYPE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">type</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> GRANULARITY granularity_value</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Для таблиц семейства <code>*MergeTree</code> можно задать дополнительные индексы в секции столбцов.</p><p>Индексы агрегируют для заданного выражения некоторые данные, а потом при <code>SELECT</code> запросе используют для пропуска блоков данных (пропускаемый блок состоит из гранул данных в количестве равном гранулярности данного индекса), на которых секция <code>WHERE</code> не может быть выполнена, тем самым уменьшая объём данных читаемых с диска.</p><p><strong>Пример</strong></p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> table_name</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    u64 UInt64</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    i32 Int32</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    s String</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">INDEX</span><span class="token plain"> a </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">u64 </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> i32</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TYPE</span><span class="token plain"> minmax GRANULARITY </span><span class="token number" style="color:rgb(9, 134, 88)">3</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">INDEX</span><span class="token plain"> b </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">u64 </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> length</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TYPE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">set</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">1000</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> GRANULARITY </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> MergeTree</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Эти индексы смогут использоваться для оптимизации следующих запросов</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">count</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">table</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> s </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;z&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">count</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">table</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> u64 </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> i32 </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">AND</span><span class="token plain"> u64 </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> length</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">s</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1234</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="available-types-of-indices">Доступные индексы<a class="hash-link" href="#available-types-of-indices" title="Direct link to heading">​</a></h4><ul><li><p><code>minmax</code> — хранит минимум и максимум выражения (если выражение - <a href="/docs/ru/sql-reference/data-types/tuple">Tuple</a>, то для каждого элемента <code>Tuple</code>), используя их для пропуска блоков аналогично первичному ключу.</p></li><li><p><code>set(max_rows)</code> — хранит уникальные значения выражения на блоке в количестве не более <code>max_rows</code> (если <code>max_rows = 0</code>, то ограничений нет), используя их для пропуска блоков, оценивая выполнимость <code>WHERE</code> выражения на хранимых данных.</p></li><li><p><code>ngrambf_v1(n, size_of_bloom_filter_in_bytes, number_of_hash_functions, random_seed)</code> — хранит <a href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank" rel="noopener noreferrer">фильтр Блума</a>, содержащий все N-граммы блока данных. Работает только с данными форматов <a href="/docs/ru/sql-reference/data-types/string">String</a>, <a href="/docs/ru/sql-reference/data-types/fixedstring">FixedString</a> и <a href="/docs/ru/sql-reference/data-types/map">Map</a> с ключами типа <code>String</code> или <code>fixedString</code>. Может быть использован для оптимизации выражений <code>EQUALS</code>, <code>LIKE</code> и <code>IN</code>.</p><ul><li><code>n</code> — размер N-граммы,</li><li><code>size_of_bloom_filter_in_bytes</code> — размер в байтах фильтра Блума (можно использовать большие значения, например, 256 или 512, поскольку сжатие компенсирует возможные издержки).</li><li><code>number_of_hash_functions</code> — количество хеш-функций, использующихся в фильтре Блума.</li><li><code>random_seed</code> — состояние генератора случайных чисел для хеш-функций фильтра Блума.</li></ul></li><li><p><code>tokenbf_v1(size_of_bloom_filter_in_bytes, number_of_hash_functions, random_seed)</code> — то же, что и<code>ngrambf_v1</code>, но хранит токены вместо N-грамм. Токены — это последовательности символов, разделенные не буквенно-цифровыми символами.</p></li><li><p><code>bloom_filter([false_positive])</code> — <a href="https://en.wikipedia.org/wiki/Bloom_filter" target="_blank" rel="noopener noreferrer">фильтр Блума</a> для указанных стоблцов.</p><p>Необязательный параметр <code>false_positive</code> — это вероятность получения ложноположительного срабатывания. Возможные значения: (0, 1). Значение по умолчанию: 0.025.</p><p>Поддерживаемые типы данных: <code>Int*</code>, <code>UInt*</code>, <code>Float*</code>, <code>Enum</code>, <code>Date</code>, <code>DateTime</code>, <code>String</code>, <code>FixedString</code>.</p><p>Фильтром могут пользоваться функции: <a href="/docs/ru/sql-reference/functions/comparison-functions">equals</a>, <a href="/docs/ru/sql-reference/functions/comparison-functions">notEquals</a>, <a href="/docs/ru/sql-reference/functions/in-functions">in</a>, <a href="/docs/ru/sql-reference/functions/in-functions">notIn</a>, <a href="/docs/ru/sql-reference/functions/array-functions#hasarr-elem">has</a>.</p></li></ul><p><strong>Примеры</strong></p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">INDEX</span><span class="token plain"> b </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">u64 </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> length</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">str</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> i32 </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> f64 </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">100</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">date</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> str</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TYPE</span><span class="token plain"> minmax GRANULARITY </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">INDEX</span><span class="token plain"> b </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">u64 </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> length</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">str</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> i32 </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> f64 </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">100</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">date</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> str</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TYPE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">set</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">100</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> GRANULARITY </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="functions-support">Поддержка для функций<a class="hash-link" href="#functions-support" title="Direct link to heading">​</a></h4><p>Условия в секции <code>WHERE</code> содержат вызовы функций, оперирующих со столбцами. Если столбец - часть индекса, ClickHouse пытается использовать индекс при выполнении функции. Для разных видов индексов, ClickHouse поддерживает различные наборы функций, которые могут использоваться индексами.</p><p>Индекс <code>set</code> используется со всеми функциями. Наборы функций для остальных индексов представлены в таблице ниже.</p><table><thead><tr><th>Функция (оператор) / Индекс</th><th>primary key</th><th>minmax</th><th>ngrambf_v1</th><th>tokenbf_v1</th><th>bloom_filter</th></tr></thead><tbody><tr><td><a href="/docs/ru/sql-reference/functions/comparison-functions#function-equals">equals (=, ==)</a></td><td>✔</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td></tr><tr><td><a href="/docs/ru/sql-reference/functions/comparison-functions#function-notequals">notEquals(!=, <!-- -->&lt;<!-- -->&gt;<!-- -->)</a></td><td>✔</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td></tr><tr><td><a href="/docs/ru/sql-reference/functions/string-search-functions#function-like">like</a></td><td>✔</td><td>✔</td><td>✔</td><td>✔</td><td>✗</td></tr><tr><td><a href="/docs/ru/sql-reference/functions/string-search-functions#function-notlike">notLike</a></td><td>✔</td><td>✔</td><td>✔</td><td>✔</td><td>✗</td></tr><tr><td><a href="/docs/ru/sql-reference/functions/string-functions#startswith">startsWith</a></td><td>✔</td><td>✔</td><td>✔</td><td>✔</td><td>✗</td></tr><tr><td><a href="/docs/ru/sql-reference/functions/string-functions#endswith">endsWith</a></td><td>✗</td><td>✗</td><td>✔</td><td>✔</td><td>✗</td></tr><tr><td><a href="/docs/ru/sql-reference/functions/string-search-functions#function-multisearchany">multiSearchAny</a></td><td>✗</td><td>✗</td><td>✔</td><td>✗</td><td>✗</td></tr><tr><td><a href="/docs/ru/sql-reference/functions/in-functions#in-functions">in</a></td><td>✔</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td></tr><tr><td><a href="/docs/ru/sql-reference/functions/in-functions#in-functions">notIn</a></td><td>✔</td><td>✔</td><td>✔</td><td>✔</td><td>✔</td></tr><tr><td><a href="/docs/ru/sql-reference/functions/comparison-functions#function-less">less (\&lt;)</a></td><td>✔</td><td>✔</td><td>✗</td><td>✗</td><td>✗</td></tr><tr><td><a href="/docs/ru/sql-reference/functions/comparison-functions#function-greater">greater (<!-- -->&gt;<!-- -->)</a></td><td>✔</td><td>✔</td><td>✗</td><td>✗</td><td>✗</td></tr><tr><td><a href="/docs/ru/sql-reference/functions/comparison-functions#function-lessorequals">lessOrEquals (\&lt;=)</a></td><td>✔</td><td>✔</td><td>✗</td><td>✗</td><td>✗</td></tr><tr><td><a href="/docs/ru/sql-reference/functions/comparison-functions#function-greaterorequals">greaterOrEquals (<!-- -->&gt;<!-- -->=)</a></td><td>✔</td><td>✔</td><td>✗</td><td>✗</td><td>✗</td></tr><tr><td><a href="/docs/ru/sql-reference/functions/array-functions#function-empty">empty</a></td><td>✔</td><td>✔</td><td>✗</td><td>✗</td><td>✗</td></tr><tr><td><a href="/docs/ru/sql-reference/functions/array-functions#function-notempty">notEmpty</a></td><td>✔</td><td>✔</td><td>✗</td><td>✗</td><td>✗</td></tr><tr><td>hasToken</td><td>✗</td><td>✗</td><td>✗</td><td>✔</td><td>✗</td></tr></tbody></table><p>Функции с постоянным агрументом, который меньше, чем размер ngram не могут использовать индекс <code>ngrambf_v1</code> для оптимизации запроса.</p><p>Фильтры Блума могут иметь ложнопозитивные срабатывания, следовательно индексы <code>ngrambf_v1</code>, <code>tokenbf_v1</code> и <code>bloom_filter</code> невозможно использовать для оптимизации запросов, в которых результат функции предполается false, например:</p><ul><li>Можно оптимизировать:<ul><li><code>s LIKE &#x27;%test%&#x27;</code></li><li><code>NOT s NOT LIKE &#x27;%test%&#x27;</code></li><li><code>s = 1</code></li><li><code>NOT s != 1</code></li><li><code>startsWith(s, &#x27;test&#x27;)</code></li></ul></li><li>Нельзя оптимизировать:<ul><li><code>NOT s LIKE &#x27;%test%&#x27;</code></li><li><code>s NOT LIKE &#x27;%test%&#x27;</code></li><li><code>NOT s = 1</code></li><li><code>s != 1</code></li><li><code>NOT startsWith(s, &#x27;test&#x27;)</code></li></ul></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="projections">Проекции<a class="hash-link" href="#projections" title="Direct link to heading">​</a></h2><p>Проекции похожи на <a href="/docs/ru/sql-reference/statements/create/view#materialized">материализованные представления</a>, но определяются на уровне кусков данных. Это обеспечивает гарантии согласованности данных наряду с автоматическим использованием в запросах.</p><p>Проекции — это экспериментальная возможность. Чтобы включить поддержку проекций, установите настройку <a href="/docs/ru/operations/settings/settings#allow-experimental-projection-optimization">allow_experimental_projection_optimization</a> в значение <code>1</code>. См. также настройку <a href="/docs/ru/operations/settings/settings#force-optimize-projection">force_optimize_projection </a>.</p><p>Проекции не поддерживаются для запросов <code>SELECT</code> с модификатором <a href="/docs/ru/sql-reference/statements/select/from#select-from-final">FINAL</a>.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="projection-query">Запрос проекции<a class="hash-link" href="#projection-query" title="Direct link to heading">​</a></h3><p>Запрос проекции — это то, что определяет проекцию. Такой запрос неявно выбирает данные из родительской таблицы.
<strong>Синтаксис</strong></p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token keyword" style="color:rgb(0, 0, 255)">column</span><span class="token plain"> list expr</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token keyword" style="color:rgb(0, 0, 255)">group</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">keys</span><span class="token plain"> expr</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">&lt;</span><span class="token plain">expr</span><span class="token operator" style="color:rgb(0, 0, 0)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Проекции можно изменить или удалить с помощью запроса <a href="/docs/ru/sql-reference/statements/alter/projection">ALTER</a>.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="projection-storage">Хранение проекции<a class="hash-link" href="#projection-storage" title="Direct link to heading">​</a></h3><p>Проекции хранятся в каталоге куска данных. Это похоже на хранение индексов, но используется подкаталог, в котором хранится анонимный кусок таблицы <code>MergeTree</code>. Таблица создается запросом определения проекции.
Если присутствует секция <code>GROUP BY</code>, то используется движок <a href="/docs/ru/engines/table-engines/mergetree-family/aggregatingmergetree">AggregatingMergeTree</a>, а все агрегатные функции преобразуются в <code>AggregateFunction</code>.
Если присутствует секция <code>ORDER BY</code>, таблица <code>MergeTree</code> использует ее в качестве выражения для первичного ключа.
Во время процесса слияния кусок данных проекции объединяется с помощью процедуры слияния хранилища. Контрольная сумма куска данных родительской таблицы включает кусок данных проекции. Другие процедуры аналогичны индексам пропуска данных.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="projection-query-analysis">Анализ запросов<a class="hash-link" href="#projection-query-analysis" title="Direct link to heading">​</a></h3><ol><li>Проверьте, можно ли использовать проекцию в данном запросе, то есть, что с ней получается тот же результат, что и с запросом к базовой таблице.</li><li>Выберите наиболее подходящее совпадение, содержащее наименьшее количество гранул для чтения.</li><li>План запроса, который использует проекции, отличается от того, который использует исходные куски данных. Если в некоторых кусках проекции отсутствуют, можно расширить план, чтобы «проецировать» на лету.</li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="concurrent-data-access">Конкурентный доступ к данным<a class="hash-link" href="#concurrent-data-access" title="Direct link to heading">​</a></h2><p>Для конкурентного доступа к таблице используется мультиверсионность. То есть, при одновременном чтении и обновлении таблицы, данные будут читаться из набора кусочков, актуального на момент запроса. Длинных блокировок нет. Вставки никак не мешают чтениям.</p><p>Чтения из таблицы автоматически распараллеливаются.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="table_engine-mergetree-ttl">TTL для столбцов и таблиц<a class="hash-link" href="#table_engine-mergetree-ttl" title="Direct link to heading">​</a></h2><p>Определяет время жизни значений.</p><p>Секция <code>TTL</code> может быть установлена как для всей таблицы, так и для каждого отдельного столбца. Для таблиц можно установить правила <code>TTL</code> для фонового перемещения кусков данных на целевые диски или тома, или правила повторного сжатия кусков данных.</p><p>Выражения должны возвращать тип <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree">Date</a> или <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree">DateTime</a>.</p><p><strong>Синтаксис</strong></p><p>Для задания времени жизни столбца:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token plain">TTL time_column</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">TTL time_column </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">interval</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Чтобы задать <code>interval</code>, используйте операторы <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree#operators-datetime">интервала времени</a>, например:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token plain">TTL date_time </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">MONTH</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">TTL date_time </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">15</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">HOUR</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="mergetree-column-ttl">TTL столбца<a class="hash-link" href="#mergetree-column-ttl" title="Direct link to heading">​</a></h3><p>Когда срок действия значений в столбце истечёт, ClickHouse заменит их значениями по умолчанию для типа данных столбца. Если срок действия всех значений столбцов в части данных истек, ClickHouse удаляет столбец из куска данных в файловой системе.</p><p>Секцию <code>TTL</code> нельзя использовать для ключевых столбцов.</p><p><strong>Примеры</strong></p><p>Создание таблицы с <code>TTL</code>:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> example_table</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    d </span><span class="token keyword" style="color:rgb(0, 0, 255)">DateTime</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    a </span><span class="token keyword" style="color:rgb(0, 0, 255)">Int</span><span class="token plain"> TTL d </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">MONTH</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    b </span><span class="token keyword" style="color:rgb(0, 0, 255)">Int</span><span class="token plain"> TTL d </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">MONTH</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    c String</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> MergeTree</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> toYYYYMM</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> d</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Добавление <code>TTL</code> на колонку существующей таблицы:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> example_table</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">MODIFY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">COLUMN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    c String TTL d </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">DAY</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Изменение <code>TTL</code> у колонки:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> example_table</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">MODIFY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">COLUMN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    c String TTL d </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">MONTH</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="mergetree-table-ttl">TTL таблицы<a class="hash-link" href="#mergetree-table-ttl" title="Direct link to heading">​</a></h3><p>Для таблицы можно задать одно выражение для устаревания данных, а также несколько выражений, при срабатывании которых данные будут перемещены на <a href="#table_engine-mergetree-multiple-volumes">некоторый диск или том</a>. Когда некоторые данные в таблице устаревают, ClickHouse удаляет все соответствующие строки. Операции перемещения или повторного сжатия данных выполняются только когда устаревают все данные в куске.</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token plain">TTL expr</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">DELETE</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">RECOMPRESS codec_name1</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token keyword" style="color:rgb(0, 0, 255)">TO</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">DISK</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;xxx&#x27;</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token keyword" style="color:rgb(0, 0, 255)">TO</span><span class="token plain"> VOLUME </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;xxx&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">DELETE</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token plain">RECOMPRESS codec_name2</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token keyword" style="color:rgb(0, 0, 255)">TO</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">DISK</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;aaa&#x27;</span><span class="token operator" style="color:rgb(0, 0, 0)">|</span><span class="token keyword" style="color:rgb(0, 0, 255)">TO</span><span class="token plain"> VOLUME </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;bbb&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> conditions</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> key_expr </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">SET</span><span class="token plain"> v1 </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> aggr_func</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">v1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> v2 </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> aggr_func</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">v2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>За каждым <code>TTL</code> выражением может следовать тип действия, которое выполняется после достижения времени, соответствующего результату <code>TTL</code> выражения:</p><ul><li><code>DELETE</code> - удалить данные (действие по умолчанию);</li><li><code>RECOMPRESS codec_name</code> - повторно сжать данные с помощью кодека <code>codec_name</code>;   </li><li><code>TO DISK &#x27;aaa&#x27;</code> - переместить данные на диск <code>aaa</code>;</li><li><code>TO VOLUME &#x27;bbb&#x27;</code> - переместить данные на том <code>bbb</code>;</li><li><code>GROUP BY</code> -  агрегировать данные.</li></ul><p>В секции <code>WHERE</code> можно задать условие удаления или агрегирования устаревших строк (для перемещения и сжатия условие <code>WHERE</code> не применимо).</p><p>Колонки, по которым агрегируются данные в <code>GROUP BY</code>, должны являться префиксом первичного ключа таблицы.</p><p>Если колонка не является частью выражения <code>GROUP BY</code> и не задается напрямую в секции <code>SET</code>, в результирующих строках она будет содержать случайное значение, взятое из одной из сгруппированных строк (как будто к ней применяется агрегирующая функция <code>any</code>).</p><p><strong>Примеры</strong></p><p>Создание таблицы с <code>TTL</code>:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> example_table</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    d </span><span class="token keyword" style="color:rgb(0, 0, 255)">DateTime</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    a </span><span class="token keyword" style="color:rgb(0, 0, 255)">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> MergeTree</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> toYYYYMM</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> d</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">TTL d </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">MONTH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">[</span><span class="token keyword" style="color:rgb(0, 0, 255)">DELETE</span><span class="token punctuation" style="color:rgb(4, 81, 165)">]</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    d </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> WEEK </span><span class="token keyword" style="color:rgb(0, 0, 255)">TO</span><span class="token plain"> VOLUME </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;aaa&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    d </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">2</span><span class="token plain"> WEEK </span><span class="token keyword" style="color:rgb(0, 0, 255)">TO</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">DISK</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;bbb&#x27;</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Изменение <code>TTL</code>:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> example_table</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">MODIFY</span><span class="token plain"> TTL d </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">DAY</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Создание таблицы, в которой строки устаревают через месяц. Устаревшие строки удаляются, если дата выпадает на понедельник:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> table_with_where</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    d </span><span class="token keyword" style="color:rgb(0, 0, 255)">DateTime</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    a </span><span class="token keyword" style="color:rgb(0, 0, 255)">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> MergeTree</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> toYYYYMM</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> d</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">TTL d </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">MONTH</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> toDayOfWeek</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Создание таблицы, в которой куски с устаревшими данными повторно сжимаются:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> table_for_recompression</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    d </span><span class="token keyword" style="color:rgb(0, 0, 255)">DateTime</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">key</span><span class="token plain"> UInt64</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">value</span><span class="token plain"> String</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> MergeTree</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> tuple</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">TTL d </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">MONTH</span><span class="token plain"> RECOMPRESS CODEC</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">ZSTD</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">17</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> d </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">YEAR</span><span class="token plain"> RECOMPRESS CODEC</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">LZ4HC</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">SETTINGS min_rows_for_wide_part </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> min_bytes_for_wide_part </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Создание таблицы, где устаревшие строки агрегируются. В результирующих строках колонка <code>x</code> содержит максимальное значение по сгруппированным строкам, <code>y</code> — минимальное значение, а <code>d</code> — случайное значение из одной из сгуппированных строк.</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> table_for_aggregation</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    d </span><span class="token keyword" style="color:rgb(0, 0, 255)">DateTime</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    k1 </span><span class="token keyword" style="color:rgb(0, 0, 255)">Int</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    k2 </span><span class="token keyword" style="color:rgb(0, 0, 255)">Int</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    x </span><span class="token keyword" style="color:rgb(0, 0, 255)">Int</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    y </span><span class="token keyword" style="color:rgb(0, 0, 255)">Int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> MergeTree</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">k1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> k2</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">TTL d </span><span class="token operator" style="color:rgb(0, 0, 0)">+</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">MONTH</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> k1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> k2 </span><span class="token keyword" style="color:rgb(0, 0, 255)">SET</span><span class="token plain"> x </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">max</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> y </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">min</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">y</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="mergetree-removing-expired-data">Удаление устаревших данных<a class="hash-link" href="#mergetree-removing-expired-data" title="Direct link to heading">​</a></h3><p>Данные с истекшим <code>TTL</code> удаляются, когда ClickHouse мёржит куски данных.</p><p>Когда ClickHouse видит, что некоторые данные устарели, он выполняет внеплановые мёржи. Для управление частотой подобных мёржей, можно задать настройку <code>merge_with_ttl_timeout</code>. Если её значение слишком низкое, придется выполнять много внеплановых мёржей, которые могут начать потреблять значительную долю ресурсов сервера.</p><p>Если вы выполните запрос <code>SELECT</code> между слияниями вы можете получить устаревшие данные. Чтобы избежать этого используйте запрос <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree#misc_operations-optimize">OPTIMIZE</a> перед <code>SELECT</code>.</p><p><strong>См. также</strong></p><ul><li>настройку <a href="/docs/ru/operations/settings/settings#ttl_only_drop_parts">ttl_only_drop_parts</a></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="table_engine-mergetree-multiple-volumes">Хранение данных таблицы на нескольких блочных устройствах<a class="hash-link" href="#table_engine-mergetree-multiple-volumes" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="introduction">Введение<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h3><p>Движки таблиц семейства <code>MergeTree</code> могут хранить данные на нескольких блочных устройствах. Это может оказаться полезным, например, при неявном разделении данных одной таблицы на «горячие» и «холодные». Наиболее свежая часть занимает малый объём и запрашивается регулярно, а большой хвост исторических данных запрашивается редко. При наличии в системе нескольких дисков, «горячая» часть данных может быть размещена на быстрых дисках (например, на NVMe SSD или в памяти), а холодная на более медленных (например, HDD).</p><p>Минимальной перемещаемой единицей для <code>MergeTree</code> является кусок данных (data part). Данные одного куска могут находится только на одном диске. Куски могут перемещаться между дисками в фоне, согласно пользовательским настройкам, а также с помощью запросов <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree#alter_move-partition">ALTER</a>.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="terms">Термины<a class="hash-link" href="#terms" title="Direct link to heading">​</a></h3><ul><li>Диск — примонтированное в файловой системе блочное устройство.</li><li>Диск по умолчанию — диск, на котором находится путь, указанный в конфигурационной настройке сервера <a href="/docs/ru/operations/server-configuration-parameters/settings#server_configuration_parameters-path">path</a>.</li><li>Том (Volume) — упорядоченный набор равноценных дисков (схоже с <a href="https://ru.wikipedia.org/wiki/JBOD" target="_blank" rel="noopener noreferrer">JBOD</a>)</li><li>Политика хранения (StoragePolicy) — множество томов с правилами перемещения данных между ними.</li></ul><p>У всех описанных сущностей при создании указываются имена, можно найти в системных таблицах <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree#system_tables-storage_policies">system.storage_policies</a> и <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree#system_tables-disks">system.disks</a>. Имя политики хранения можно указать в настройке <code>storage_policy</code> движков таблиц семейства <code>MergeTree</code>.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="table_engine-mergetree-multiple-volumes_configure">Конфигурация<a class="hash-link" href="#table_engine-mergetree-multiple-volumes_configure" title="Direct link to heading">​</a></h3><p>Диски, тома и политики хранения задаются внутри тега <code>&lt;storage_configuration&gt;</code> в основном файле <code>config.xml</code> или в отдельном файле в директории <code>config.d</code>.</p><p>Структура конфигурации:</p><div class="codeBlockContainer_I0IT language-xml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-xml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">storage_configuration</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disks</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disk_name_1</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- disk name --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">path</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">/mnt/fast_ssd/clickhouse/</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">path</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disk_name_1</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disk_name_2</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">path</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">/mnt/hdd1/clickhouse/</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">path</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">keep_free_space_bytes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">10485760</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">keep_free_space_bytes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disk_name_2</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disk_name_3</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">path</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">/mnt/hdd2/clickhouse/</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">path</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">keep_free_space_bytes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">10485760</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">keep_free_space_bytes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disk_name_3</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disks</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">storage_configuration</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Теги:</p><ul><li><code>&lt;disk_name_N&gt;</code> — имя диска. Имена должны быть разными для всех дисков.</li><li><code>path</code> — путь по которому будут храниться данные сервера (каталоги <code>data</code> и <code>shadow</code>), должен быть терминирован <code>/</code>.</li><li><code>keep_free_space_bytes</code> — размер зарезервированного свободного места на диске.</li></ul><p>Порядок задания дисков не имеет значения.</p><p>Общий вид конфигурации политик хранения:</p><div class="codeBlockContainer_I0IT language-xml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-xml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">storage_configuration</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">policies</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">policy_name_1</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">volumes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">volume_name_1</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">disk_name_from_disks_configuration</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">max_data_part_size_bytes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">1073741824</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">max_data_part_size_bytes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">volume_name_1</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">volume_name_2</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- configuration --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">volume_name_2</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- more volumes --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">volumes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">move_factor</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">0.2</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">move_factor</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">policy_name_1</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">policy_name_2</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- configuration --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">policy_name_2</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- more policies --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">policies</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">storage_configuration</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Тэги:</p><ul><li><code>policy_name_N</code> — название политики. Названия политик должны быть уникальны.</li><li><code>volume_name_N</code> — название тома. Названия томов должны быть уникальны.</li><li><code>disk</code> — диск, находящийся внутри тома.</li><li><code>max_data_part_size_bytes</code> — максимальный размер куска данных, который может находится на любом из дисков этого тома. Если в результате слияния размер куска ожидается больше, чем max_data_part_size_bytes, то этот кусок будет записан в следующий том. В основном эта функция позволяет хранить новые / мелкие куски на горячем (SSD) томе и перемещать их на холодный (HDD) том, когда они достигают большого размера. Не используйте этот параметр, если политика имеет только один том. </li><li><code>move_factor</code> — доля доступного свободного места на томе, если места становится меньше, то данные начнут перемещение на следующий том, если он есть (по умолчанию 0.1). Для перемещения куски сортируются по размеру от большего к меньшему (по убыванию) и выбираются куски, совокупный размер которых достаточен для соблюдения условия <code>move_factor</code>, если совокупный размер всех партов недостаточен, будут перемещены все парты.</li><li><code>prefer_not_to_merge</code> — Отключает слияние кусков данных, хранящихся на данном томе. Если данная настройка включена, то слияние данных, хранящихся на данном томе, не допускается. Это позволяет контролировать работу ClickHouse с медленными дисками.</li></ul><p>Примеры конфигураций:</p><div class="codeBlockContainer_I0IT language-xml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-xml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">storage_configuration</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">policies</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">hdd_in_order</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- policy name --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">volumes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">single</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(0, 128, 0)">&lt;!-- volume name --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">disk1</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">disk2</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">single</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">volumes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">hdd_in_order</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">moving_from_ssd_to_hdd</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">volumes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">hot</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">fast_ssd</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">max_data_part_size_bytes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">1073741824</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">max_data_part_size_bytes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">hot</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">cold</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">disk1</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">cold</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">volumes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">move_factor</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">0.2</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">move_factor</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">moving_from_ssd_to_hdd</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">small_jbod_with_external_no_merges</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">volumes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">main</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">jbod1</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">main</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">external</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">external</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">prefer_not_to_merge</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">true</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">prefer_not_to_merge</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">external</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">volumes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">small_jbod_with_external_no_merges</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">policies</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">storage_configuration</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>В приведенном примере, политика <code>hdd_in_order</code> реализует прицип <a href="https://ru.wikipedia.org/wiki/Round-robin_(%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC)" target="_blank" rel="noopener noreferrer">round-robin</a>. Так как в политике есть всего один том (<code>single</code>), то все записи производятся на его диски по круговому циклу. Такая политика может быть полезна при наличии в системе нескольких похожих дисков, но при этом не сконфигурирован RAID. Учтите, что каждый отдельный диск ненадёжен и чтобы не потерять важные данные это необходимо скомпенсировать за счет хранения данных в трёх копиях.</p><p>Если система содержит диски различных типов, то может пригодиться политика <code>moving_from_ssd_to_hdd</code>. В томе <code>hot</code> находится один SSD-диск (<code>fast_ssd</code>), а также задается ограничение на максимальный размер куска, который может храниться на этом томе (1GB). Все куски такой таблицы больше 1GB будут записываться сразу на том <code>cold</code>, в котором содержится один HDD-диск <code>disk1</code>. Также, при заполнении диска <code>fast_ssd</code> более чем на 80% данные будут переносится на диск <code>disk1</code> фоновым процессом.</p><p>Порядок томов в политиках хранения важен, при достижении условий на переполнение тома данные переносятся на следующий. Порядок дисков в томах так же важен, данные пишутся по очереди на каждый из них.</p><p>После задания конфигурации политик хранения их можно использовать, как настройку при создании таблиц:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> table_with_non_default_policy </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    EventDate </span><span class="token keyword" style="color:rgb(0, 0, 255)">Date</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    OrderID UInt64</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    BannerID UInt64</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    SearchPhrase String</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> MergeTree</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">OrderID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> BannerID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> toYYYYMM</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">EventDate</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">SETTINGS storage_policy </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;moving_from_ssd_to_hdd&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>По умолчанию используется политика хранения <code>default</code> в которой есть один том и один диск, указанный в <code>&lt;path&gt;</code>.
Изменить политику хранения после создания таблицы можно при помощи запроса <!-- -->[ALTER TABLE ... MODIFY SETTING]<!-- -->. При этом необходимо учесть, что новая политика должна содержать все тома и диски предыдущей политики с теми же именами.</p><p>Количество потоков для фоновых перемещений кусков между дисками можно изменить с помощью настройки <a href="/docs/ru/operations/settings/settings#background_move_pool_size">background_move_pool_size</a></p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="details">Особенности работы<a class="hash-link" href="#details" title="Direct link to heading">​</a></h3><p>В таблицах <code>MergeTree</code> данные попадают на диск несколькими способами:</p><ul><li>В результате вставки (запрос <code>INSERT</code>).</li><li>В фоновых операциях слияний и <a href="/docs/ru/sql-reference/statements/alter/#mutations">мутаций</a>.</li><li>При скачивании данных с другой реплики.</li><li>В результате заморозки партиций <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree#alter_freeze-partition">ALTER TABLE … FREEZE PARTITION</a>.</li></ul><p>Во всех случаях, кроме мутаций и заморозки партиций, при записи куска выбирается том и диск в соответствии с указанной конфигурацией хранилища:</p><ol><li>Выбирается первый по порядку том, на котором есть свободное место для записи куска (<code>unreserved_space &gt; current_part_size</code>) и который позволяет записывать куски требуемого размера <code>max_data_part_size_bytes &gt; current_part_size</code>.</li><li>Внутри тома выбирается следующий диск после того, на который была предыдущая запись и на котором свободного места больше чем размер куска (<code>unreserved_space - keep_free_space_bytes &gt; current_part_size</code>)</li></ol><p>Мутации и запросы заморозки партиций в реализации используют <a href="https://ru.wikipedia.org/wiki/%D0%96%D1%91%D1%81%D1%82%D0%BA%D0%B0%D1%8F_%D1%81%D1%81%D1%8B%D0%BB%D0%BA%D0%B0" target="_blank" rel="noopener noreferrer">жесткие ссылки</a>. Жесткие ссылки между различными дисками не поддерживаются, поэтому в случае таких операций куски размещаются на тех же дисках, что и исходные.</p><p>В фоне куски перемещаются между томами на основе информации о занятом месте (настройка <code>move_factor</code>) по порядку, в котором указаны тома в конфигурации. Данные никогда не перемещаются с последнего тома и на первый том. Следить за фоновыми перемещениями можно с помощью системных таблиц <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree#system_tables-part-log">system.part_log</a> (поле <code>type = MOVE_PART</code>) и <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree#system_tables-parts">system.parts</a> (поля <code>path</code> и <code>disk</code>). Также подробная информация о перемещениях доступна в логах сервера.
С помощью запроса <a href="/docs/ru/engines/table-engines/mergetree-family/mergetree#alter_move-partition">ALTER TABLE … MOVE PART<!-- -->|<!-- -->PARTITION … TO VOLUME<!-- -->|<!-- -->DISK …</a> пользователь может принудительно перенести кусок или партицию с одного раздела на другой. При этом учитываются все ограничения, указанные для фоновых операций. Запрос самостоятельно инициирует процесс перемещения не дожидаясь фоновых операций. В случае недостатка места или неудовлетворения ограничениям пользователь получит сообщение об ошибке.</p><p>Перемещения данных не взаимодействуют с репликацией данных, поэтому на разных репликах одной и той же таблицы могут быть указаны разные политики хранения.</p><p>После выполнения фоновых слияний или мутаций старые куски не удаляются сразу, а через некоторое время (табличная настройка <code>old_parts_lifetime</code>). Также они не перемещаются на другие тома или диски, поэтому до момента удаления они продолжают учитываться при подсчёте занятого дискового пространства.</p><p>Пользователь может сбалансированно распределять новые большие куски данных по разным дискам тома <a href="https://en.wikipedia.org/wiki/Non-RAID_drive_architectures" target="_blank" rel="noopener noreferrer">JBOD</a>, используя настройку <a href="/docs/ru/operations/settings/merge-tree-settings#min-bytes-to-rebalance-partition-over-jbod">min_bytes_to_rebalance_partition_over_jbod</a>.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="table_engine-mergetree-s3">Использование сервиса S3 для хранения данных<a class="hash-link" href="#table_engine-mergetree-s3" title="Direct link to heading">​</a></h2><p>Таблицы семейства <code>MergeTree</code> могут хранить данные в сервисе <a href="https://aws.amazon.com/s3/" target="_blank" rel="noopener noreferrer">S3</a> при использовании диска типа <code>s3</code>.</p><p>Конфигурация:</p><div class="codeBlockContainer_I0IT language-xml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-xml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">storage_configuration</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disks</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">s3</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">type</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">s3</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">type</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">endpoint</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">https://storage.yandexcloud.net/my-bucket/root-path/</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">endpoint</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">access_key_id</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">your_access_key_id</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">access_key_id</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">secret_access_key</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">your_secret_access_key</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">secret_access_key</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">region</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">region</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">proxy</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">uri</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">http://proxy1</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">uri</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">uri</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">http://proxy2</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">uri</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">proxy</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">connect_timeout_ms</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">10000</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">connect_timeout_ms</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">request_timeout_ms</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">5000</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">request_timeout_ms</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">retry_attempts</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">10</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">retry_attempts</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">single_read_retries</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">4</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">single_read_retries</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">min_bytes_for_seek</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">1000</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">min_bytes_for_seek</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">metadata_path</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">/var/lib/clickhouse/disks/s3/</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">metadata_path</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">cache_enabled</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">true</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">cache_enabled</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">cache_path</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">/var/lib/clickhouse/disks/s3/cache/</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">cache_path</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">skip_access_check</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">false</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">skip_access_check</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">s3</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disks</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">storage_configuration</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Обязательные параметры:</p><ul><li><code>endpoint</code> — URL точки приема запроса на стороне S3 в <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/VirtualHosting.html" target="_blank" rel="noopener noreferrer">форматах</a> <code>path</code> или <code>virtual hosted</code>. URL точки должен содержать бакет и путь к корневой директории на сервере, где хранятся данные.</li><li><code>access_key_id</code> — id ключа доступа к S3.</li><li><code>secret_access_key</code> — секретный ключ доступа к S3.</li></ul><p>Необязательные параметры:</p><ul><li><code>region</code> — название региона S3.</li><li><code>use_environment_credentials</code> — признак, нужно ли считывать учетные данные AWS из сетевого окружения, а также из переменных окружения <code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code> и <code>AWS_SESSION_TOKEN</code>, если они есть. Значение по умолчанию: <code>false</code>.</li><li><code>use_insecure_imds_request</code> — признак, нужно ли использовать менее безопасное соединение при выполнении запроса к IMDS при получении учётных данных из метаданных Amazon EC2. Значение по умолчанию: <code>false</code>.</li><li><code>proxy</code> — конфигурация прокси-сервера для конечной точки S3. Каждый элемент <code>uri</code> внутри блока <code>proxy</code> должен содержать URL прокси-сервера.</li><li><code>connect_timeout_ms</code> — таймаут подключения к сокету в миллисекундах. Значение по умолчанию: 10 секунд.</li><li><code>request_timeout_ms</code> — таймаут выполнения запроса в миллисекундах. Значение по умолчанию: 5 секунд.</li><li><code>retry_attempts</code> — число попыток выполнения запроса в случае возникновения ошибки. Значение по умолчанию: <code>10</code>.</li><li><code>single_read_retries</code> — число попыток выполнения запроса в случае возникновения ошибки в процессе чтения. Значение по умолчанию: <code>4</code>.</li><li><code>min_bytes_for_seek</code> — минимальное количество байтов, которые используются для операций поиска вместо последовательного чтения. Значение по умолчанию: 1 МБайт.</li><li><code>metadata_path</code> — путь к локальному файловому хранилищу для хранения файлов с метаданными для S3. Значение по умолчанию: <code>/var/lib/clickhouse/disks/&lt;disk_name&gt;/</code>.</li><li><code>cache_enabled</code> — признак, разрешено ли хранение кэша засечек и файлов индекса в локальной файловой системе. Значение по умолчанию: <code>true</code>.</li><li><code>cache_path</code> — путь в локальной файловой системе, где будут храниться кэш засечек и файлы индекса. Значение по умолчанию: <code>/var/lib/clickhouse/disks/&lt;disk_name&gt;/cache/</code>.</li><li><code>skip_access_check</code> — признак, выполнять ли проверку доступов при запуске диска. Если установлено значение <code>true</code>, то проверка не выполняется. Значение по умолчанию: <code>false</code>.</li></ul><p>Диск S3 может быть сконфигурирован как <code>main</code> или <code>cold</code>:</p><div class="codeBlockContainer_I0IT language-xml theme-code-block"><div class="codeBlockContent_wNvx" style="color:#000000;background-color:#ffffff"><pre tabindex="0" class="prism-code language-xml codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#000000"><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">storage_configuration</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disks</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">s3</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">type</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">s3</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">type</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">endpoint</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">https://storage.yandexcloud.net/my-bucket/root-path/</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">endpoint</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">access_key_id</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">your_access_key_id</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">access_key_id</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">secret_access_key</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">your_secret_access_key</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">secret_access_key</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">s3</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disks</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">policies</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">s3_main</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">volumes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">main</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">s3</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">main</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">volumes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">s3_main</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">s3_cold</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">volumes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">main</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">default</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">main</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">external</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">s3</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">disk</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">external</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">volumes</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">            </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;</span><span class="token tag" style="color:rgb(128, 0, 0)">move_factor</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain">0.2</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">move_factor</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">s3_cold</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">policies</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&lt;/</span><span class="token tag" style="color:rgb(128, 0, 0)">storage_configuration</span><span class="token tag punctuation" style="color:rgb(4, 81, 165)">&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>Если диск сконфигурирован как <code>cold</code>, данные будут переноситься в S3 при срабатывании правил TTL или когда свободное место на локальном диске станет меньше порогового значения, которое определяется как <code>move_factor * disk_size</code>.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="virtual-columns">Виртуальные столбцы<a class="hash-link" href="#virtual-columns" title="Direct link to heading">​</a></h2><ul><li><code>_part</code> — Имя куска.</li><li><code>_part_index</code> — Номер куска по порядку в результате запроса.</li><li><code>_partition_id</code> — Имя партиции.</li><li><code>_part_uuid</code> — Уникальный идентификатор куска (если включена MergeTree настройка <code>assign_part_uuids</code>).</li><li><code>_partition_value</code> — Значения (кортеж) выражения <code>partition by</code>.</li><li><code>_sample_factor</code> — Коэффициент сэмплирования (из запроса).</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ClickHouse/ClickHouse/tree/master/docs/ru/engines/table-engines/mergetree-family/mergetree.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/ru/engines/table-engines/mergetree-family/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">MergeTree Family</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/ru/engines/table-engines/mergetree-family/replication"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Репликация данных</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#table_engine-mergetree-creating-a-table" class="table-of-contents__link toc-highlight">Создание таблицы</a><ul><li><a href="#mergetree-query-clauses" class="table-of-contents__link toc-highlight">Секции запроса</a></li></ul></li><li><a href="#mergetree-data-storage" class="table-of-contents__link toc-highlight">Хранение данных</a></li><li><a href="#primary-keys-and-indexes-in-queries" class="table-of-contents__link toc-highlight">Первичные ключи и индексы в запросах</a><ul><li><a href="#selecting-the-primary-key" class="table-of-contents__link toc-highlight">Выбор первичного ключа</a></li><li><a href="#choosing-a-primary-key-that-differs-from-the-sorting-key" class="table-of-contents__link toc-highlight">Первичный ключ, отличный от ключа сортировки</a></li><li><a href="#use-of-indexes-and-partitions-in-queries" class="table-of-contents__link toc-highlight">Использование индексов и партиций в запросах</a></li><li><a href="#use-of-index-for-partially-monotonic-primary-keys" class="table-of-contents__link toc-highlight">Использование индекса для частично-монотонных первичных ключей</a></li><li><a href="#table_engine-mergetree-data_skipping-indexes" class="table-of-contents__link toc-highlight">Индексы пропуска данных</a></li></ul></li><li><a href="#projections" class="table-of-contents__link toc-highlight">Проекции</a><ul><li><a href="#projection-query" class="table-of-contents__link toc-highlight">Запрос проекции</a></li><li><a href="#projection-storage" class="table-of-contents__link toc-highlight">Хранение проекции</a></li><li><a href="#projection-query-analysis" class="table-of-contents__link toc-highlight">Анализ запросов</a></li></ul></li><li><a href="#concurrent-data-access" class="table-of-contents__link toc-highlight">Конкурентный доступ к данным</a></li><li><a href="#table_engine-mergetree-ttl" class="table-of-contents__link toc-highlight">TTL для столбцов и таблиц</a><ul><li><a href="#mergetree-column-ttl" class="table-of-contents__link toc-highlight">TTL столбца</a></li><li><a href="#mergetree-table-ttl" class="table-of-contents__link toc-highlight">TTL таблицы</a></li><li><a href="#mergetree-removing-expired-data" class="table-of-contents__link toc-highlight">Удаление устаревших данных</a></li></ul></li><li><a href="#table_engine-mergetree-multiple-volumes" class="table-of-contents__link toc-highlight">Хранение данных таблицы на нескольких блочных устройствах</a><ul><li><a href="#introduction" class="table-of-contents__link toc-highlight">Введение</a></li><li><a href="#terms" class="table-of-contents__link toc-highlight">Термины</a></li><li><a href="#table_engine-mergetree-multiple-volumes_configure" class="table-of-contents__link toc-highlight">Конфигурация</a></li><li><a href="#details" class="table-of-contents__link toc-highlight">Особенности работы</a></li></ul></li><li><a href="#table_engine-mergetree-s3" class="table-of-contents__link toc-highlight">Использование сервиса S3 для хранения данных</a></li><li><a href="#virtual-columns" class="table-of-contents__link toc-highlight">Виртуальные столбцы</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ClickHouse</div><ul class="footer__items"><li class="footer__item"><a href="https://clickhouse.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Company</a></li><li class="footer__item"><a href="https://clickhouse.com/cloud/" target="_blank" rel="noopener noreferrer" class="footer__link-item">ClickHouse as a Service</a></li><li class="footer__item"><a href="https://clickhouse.com/careers/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Careers</a></li><li class="footer__item"><a href="https://clickhouse.com/learn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Learn ClickHouse</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/ClickHouse/ClickHouse" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://clickhouse.com/blog/en/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/c/ClickHouseDB" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ClickHouseDB" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://join.slack.com/t/clickhousedb/shared_invite/zt-rxm3rdrk-lIUmhLC3V8WTaL0TGxsOmg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Policies</div><ul class="footer__items"><li class="footer__item"><a href="https://clickhouse.com/legal/trademark-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trademark Policy</a></li><li class="footer__item"><a href="https://clickhouse.com/legal/privacy-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy</a></li><li class="footer__item"><a href="https://clickhouse.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/docs/img/clickhouse.svg" alt="ClickHouse Documentation" class="themedImage_W2Cr themedImage--light_TfLj footer__logo"><img src="/docs/img/clickhouse.svg" alt="ClickHouse Documentation" class="themedImage_W2Cr themedImage--dark_oUvU footer__logo"></div><div class="footer__copyright">Copyright &copy; 2016&ndash;2022 ClickHouse, Inc. ClickHouse Docs provided under the Creative Commons CC BY-NC-SA 4.0 license. ClickHouse&reg; is a registered trademark of ClickHouse, Inc.</div></div></div></footer></div>
<script src="/docs/assets/js/runtime~main.832195c1.js"></script>
<script src="/docs/assets/js/main.0e6c66ce.js"></script>
</body>
</html>